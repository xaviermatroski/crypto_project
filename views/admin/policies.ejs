

<div class="container mt-4">
    <h2>Access Policies Management</h2>
    
    <% if (error) { %>
        <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <!-- Create New Policy Button -->
    <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#createPolicyModal">
        Create New Policy
    </button>

    <!-- Policies List -->
    <div class="card">
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Created By</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% policies.forEach(policy => { %>
                        <tr>
                            <td><%= policy.name %></td>
                            <td><%= policy.description %></td>
                            <td><%= policy.createdBy.userName %></td>
                            <td><%= new Date(policy.createdAt).toLocaleString() %></td>
                            <td>
                                <button class="btn btn-sm btn-info" 
                                        onclick="viewPolicy('<%= policy.policyId %>')">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Policy Modal -->
<div class="modal fade" id="createPolicyModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Access Policy</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form action="/admin/policies/add" method="POST" id="policyForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Policy Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Categories</label>
                        <div id="categoriesContainer">
                            <div class="category-item mb-2">
                                <input type="text" class="form-control" placeholder="Category name">
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addCategory()">
                            Add Category
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Access Rules</label>
                        <div id="rulesContainer">
                            <div class="rule-item mb-2">
                                <select class="form-control mb-1" name="roleSelect">
                                    <option value="investigator">Investigator</option>
                                    <option value="forensics_officer">Forensics Officer</option>
                                    <option value="judiciary">Judiciary</option>
                                </select>
                                <select class="form-control mb-1" name="permissionSelect">
                                    <option value="read">Read</option>
                                    <option value="write">Write</option>
                                    <option value="delete">Delete</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addRule()">
                            Add Rule
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Policy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript for handling policy creation -->
<script>
function addCategory() {
    const container = document.getElementById('categoriesContainer');
    const div = document.createElement('div');
    div.className = 'category-item mb-2 d-flex';
    div.innerHTML = `
        <input type="text" class="form-control mr-2" placeholder="Category name">
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
            Remove
        </button>
    `;
    container.appendChild(div);
}

function addRule() {
    const container = document.getElementById('rulesContainer');
    const div = document.createElement('div');
    div.className = 'rule-item mb-2 d-flex';
    div.innerHTML = `
        <div class="flex-grow-1 mr-2">
            <select class="form-control mb-1" name="roleSelect">
                <option value="investigator">Investigator</option>
                <option value="forensics_officer">Forensics Officer</option>
                <option value="judiciary">Judiciary</option>
            </select>
            <select class="form-control" name="permissionSelect">
                <option value="read">Read</option>
                <option value="write">Write</option>
                <option value="delete">Delete</option>
            </select>
        </div>
        <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
            Remove
        </button>
    `;
    container.appendChild(div);
}

document.getElementById('policyForm').onsubmit = function(e) {
    e.preventDefault();
    
    // Gather categories
    const categories = Array.from(document.querySelectorAll('.category-item input'))
        .map(input => input.value)
        .filter(value => value.trim() !== '');
    
    // Gather rules
    const rules = Array.from(document.querySelectorAll('.rule-item')).map(item => {
        const selects = item.querySelectorAll('select');
        return {
            role: selects[0].value,
            permission: selects[1].value
        };
    });

    // Add hidden fields with JSON data
    const categoriesInput = document.createElement('input');
    categoriesInput.type = 'hidden';
    categoriesInput.name = 'categories';
    categoriesInput.value = JSON.stringify(categories);
    
    const rulesInput = document.createElement('input');
    rulesInput.type = 'hidden';
    rulesInput.name = 'rules';
    rulesInput.value = JSON.stringify(rules);
    
    this.appendChild(categoriesInput);
    this.appendChild(rulesInput);
    
    this.submit();
};

function viewPolicy(policyId) {
    window.location.href = `/admin/policies/${policyId}`;
}
</script>


